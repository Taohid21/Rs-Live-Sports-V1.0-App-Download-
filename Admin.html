<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stream Commander Pro</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <style>
        :root {
            --bg: #0f172a;
            --card: #1e293b;
            --primary: #6366f1;
            --accent: #8b5cf6;
            --text: #f1f5f9;
            --text-dim: #94a3b8;
            --danger: #ef4444;
            --success: #22c55e;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', system-ui, sans-serif; }
        body { background: var(--bg); color: var(--text); padding: 20px; height: 100vh; display: flex; flex-direction: column; gap: 20px; }
        
        /* Header */
        header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 20px; border-bottom: 1px solid #334155; }
        h1 { font-size: 1.5rem; background: linear-gradient(to right, var(--primary), var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        /* Layout */
        .dashboard { display: grid; grid-template-columns: 300px 1fr; gap: 20px; height: 100%; overflow: hidden; }
        @media (max-width: 768px) { .dashboard { grid-template-columns: 1fr; overflow-y: auto; } }

        /* Sidebar (Controls) */
        .sidebar { display: flex; flex-direction: column; gap: 20px; }
        .card { background: var(--card); padding: 20px; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border: 1px solid #334155; }
        
        /* Upload Area */
        .upload-zone { border: 2px dashed #475569; border-radius: 12px; padding: 20px; text-align: center; cursor: pointer; transition: 0.3s; }
        .upload-zone:hover { border-color: var(--primary); background: rgba(99, 102, 241, 0.1); }
        
        /* Buttons */
        button { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; margin-top: 10px; }
        .btn-primary { background: linear-gradient(135deg, var(--primary), var(--accent)); color: white; }
        .btn-primary:active { transform: scale(0.98); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-disabled { background: #475569; cursor: not-allowed; opacity: 0.6; }

        /* Library Grid */
        .library-container { display: flex; flex-direction: column; gap: 15px; height: 100%; overflow: hidden; }
        .library-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; overflow-y: auto; padding-right: 5px; }
        
        .media-item { position: relative; background: #020617; border-radius: 10px; overflow: hidden; cursor: pointer; border: 2px solid transparent; transition: 0.2s; }
        .media-item:hover { transform: translateY(-3px); }
        .media-item.selected { border-color: var(--success); }
        .media-item img, .media-item video { width: 100%; height: 100px; object-fit: cover; }
        .media-info { padding: 8px; font-size: 0.8rem; color: var(--text-dim); display: flex; justify-content: space-between; }
        .badge { background: rgba(0,0,0,0.6); padding: 2px 6px; border-radius: 4px; position: absolute; top: 5px; right: 5px; font-size: 0.7rem; }
        .select-count { position: absolute; top: 5px; left: 5px; background: var(--success); width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; display: none; }
        .media-item.selected .select-count { display: flex; }

        /* Status */
        #statusIndicator { font-weight: bold; padding: 5px 10px; border-radius: 20px; font-size: 0.9rem; }
        .status-live { background: rgba(239, 68, 68, 0.2); color: var(--danger); }
        .status-ad { background: rgba(34, 197, 94, 0.2); color: var(--success); }
        
        .queue-info { margin-top: 10px; font-size: 0.9rem; color: var(--text-dim); text-align: center; }
    </style>
</head>
<body>

    <header>
        <h1>üì∫ Stream Commander</h1>
        <div id="statusIndicator" class="status-live">‚óè LIVE FEED ACTIVE</div>
    </header>

    <div class="dashboard">
        <!-- Left Sidebar: Upload & Controls -->
        <div class="sidebar">
            <!-- Upload Card -->
            <div class="card">
                <h3>Upload New Media</h3>
                <p style="font-size: 0.8rem; color: #94a3b8; margin-bottom: 10px;">Images (10s default) or Videos</p>
                <input type="file" id="fileInput" hidden accept="image/*,video/*">
                <div class="upload-zone" onclick="document.getElementById('fileInput').click()">
                    <span class="material-icons-round" style="font-size: 40px; color: var(--text-dim)">cloud_upload</span>
                    <p id="uploadText">Click to Upload</p>
                </div>
                <button id="uploadBtn" class="btn-primary" onclick="uploadMedia()" style="display:none;">Start Upload</button>
            </div>

            <!-- Control Card -->
            <div class="card">
                <h3>Playback Control</h3>
                <div class="queue-info" id="queueStatus">0 items selected</div>
                
                <button id="runBtn" class="btn-primary btn-disabled" onclick="runPlaylist()" disabled>
                    <span class="material-icons-round">play_arrow</span> RUN QUEUE
                </button>
                
                <button id="stopBtn" class="btn-danger" onclick="stopStream()">
                    <span class="material-icons-round">stop</span> STOP / RESET
                </button>

                <div style="margin-top: 15px; font-size: 0.8rem; color: #64748b;">
                    * Keep this tab open while queue is running.
                </div>
            </div>
        </div>

        <!-- Right Area: Media Library -->
        <div class="card library-container">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3>Media Library</h3>
                <button onclick="clearSelection()" style="width: auto; font-size: 0.8rem; padding: 5px 10px; background: #334155;">Clear Selection</button>
            </div>
            <div class="library-grid" id="libraryGrid">
                <!-- Items will be injected here -->
                <div style="text-align:center; width: 100%; padding: 20px; color: #64748b;">Loading Library...</div>
            </div>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, set, push, onValue, remove } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    // --- CONFIGURATION ---
    const firebaseConfig = {
  apiKey: "AIzaSyAb8YsPMOY53GxiycCL6G0MPZdgWe3nnyY",
  authDomain: "movie-92659.firebaseapp.com",
  databaseURL: "https://movie-92659-default-rtdb.firebaseio.com",
  projectId: "movie-92659",
  storageBucket: "movie-92659.firebasestorage.app",
  messagingSenderId: "1090734362509",
  appId: "1:1090734362509:web:86be5583f6e8fcfdfa77c4",
  measurementId: "G-XF1TEP0DSJ"
};
    const cloudName = "dwgvvzbvn"; // ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ Cloudinary ‡¶®‡¶æ‡¶Æ ‡¶¨‡¶∏‡¶æ‡¶®
    const uploadPreset = "storyapp"; // Unsigned Preset ‡¶®‡¶æ‡¶Æ ‡¶¨‡¶∏‡¶æ‡¶®

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let selectedQueue = [];
    let isPlaying = false;

    // --- 1. LIBRARY SYSTEM ---
    const libraryGrid = document.getElementById('libraryGrid');
    
    onValue(ref(db, 'media_library'), (snapshot) => {
        libraryGrid.innerHTML = '';
        const data = snapshot.val();
        if (!data) {
            libraryGrid.innerHTML = '<p style="padding:20px;">No media found.</p>';
            return;
        }

        Object.entries(data).forEach(([key, item]) => {
            const el = document.createElement('div');
            el.className = `media-item ${selectedQueue.find(q => q.id === key) ? 'selected' : ''}`;
            el.onclick = () => toggleSelection(key, item);
            
            // Thumbnail decision
            let thumbnail = item.type === 'video' ? (item.url.replace(/\.[^/.]+$/, ".jpg")) : item.url;
            
            el.innerHTML = `
                <div class="badge">${item.type.toUpperCase()} ${item.duration ? Math.round(item.duration)+'s' : ''}</div>
                <div class="select-count" id="count-${key}"></div>
                <img src="${thumbnail}" loading="lazy">
                <div class="media-info">
                    <span>${new Date(item.uploadedAt).toLocaleDateString()}</span>
                    <span class="material-icons-round" style="font-size: 14px; color: #ef4444;" onclick="deleteItem(event, '${key}')">delete</span>
                </div>
            `;
            libraryGrid.appendChild(el);
            updateSelectionUI();
        });
    });

    // --- 2. SELECTION LOGIC ---
    window.toggleSelection = (key, item) => {
        const existingIndex = selectedQueue.findIndex(q => q.id === key);
        if (existingIndex > -1) {
            selectedQueue.splice(existingIndex, 1); // Remove
        } else {
            selectedQueue.push({ ...item, id: key }); // Add
        }
        updateSelectionUI();
    };

    window.clearSelection = () => {
        selectedQueue = [];
        updateSelectionUI();
    }

    window.deleteItem = (e, key) => {
        e.stopPropagation();
        if(confirm('Delete this item permanently?')) {
            remove(ref(db, `media_library/${key}`));
        }
    }

    function updateSelectionUI() {
        document.querySelectorAll('.media-item').forEach(el => el.classList.remove('selected'));
        
        selectedQueue.forEach((item, index) => {
            // Find element by ID logic (simplification) - In real DOM query
             // This part relies on re-rendering or efficient DOM updates. 
             // For simplicity, we are re-fetching via listener mostly, but for instant feedback:
             // We rely on the CSS class injection in the loop above.
        });

        // Re-render classes manually for better performance than full reload
        const items = document.querySelectorAll('.media-item');
        // Reset all
        items.forEach(i => {
            i.classList.remove('selected');
            const counter = i.querySelector('.select-count');
            if(counter) counter.innerText = '';
        });

        // Apply selection
        selectedQueue.forEach((q, idx) => {
            // This assumes order in DOM matches library, which works if library doesn't change sort
            // A better way is finding by onclick handler or ID data attribute
            // Let's just rely on the Visual Feedback in the Loop:
            // Since I used onValue, I need to store selection in a variable and let onValue re-render OR
            // update DOM directly.
        });
        
        // Let's trigger a re-render of the grid or just update button state
        const runBtn = document.getElementById('runBtn');
        const queueInfo = document.getElementById('queueStatus');
        
        queueInfo.innerText = `${selectedQueue.length} items ready to play`;
        
        if (selectedQueue.length > 0) {
            runBtn.classList.remove('btn-disabled');
            runBtn.disabled = false;
        } else {
            runBtn.classList.add('btn-disabled');
            runBtn.disabled = true;
        }

        // Update visual selection numbers
        selectedQueue.forEach((item, index) => {
           const countEl = document.getElementById(`count-${item.id}`);
           if(countEl) {
               countEl.parentElement.classList.add('selected');
               countEl.innerText = index + 1;
           }
        });
    }

    // --- 3. PLAYLIST RUNNER (THE BRAIN) ---
    window.runPlaylist = async () => {
        if (selectedQueue.length === 0) return;
        
        isPlaying = true;
        document.getElementById('runBtn').disabled = true;
        document.getElementById('runBtn').innerText = "PLAYING QUEUE...";
        document.getElementById('statusIndicator').innerText = "‚óè AD BREAK ACTIVE";
        document.getElementById('statusIndicator').className = "status-ad";

        for (let i = 0; i < selectedQueue.length; i++) {
            if (!isPlaying) break; // Stop if cancelled

            const item = selectedQueue[i];
            const duration = item.duration || 10; // Default 10s if missing

            // 1. Update Firebase to show this item
            await set(ref(db, 'streamState'), {
                active: true,
                type: item.type,
                src: item.url,
                duration: duration, // Send duration to viewer for countdown
                startTime: Date.now()
            });

            // 2. Wait for the duration of the item
            await new Promise(resolve => setTimeout(resolve, duration * 1000));
        }

        // Playlist Finished
        stopStream();
    };

    window.stopStream = () => {
        isPlaying = false;
        set(ref(db, 'streamState'), { active: false });
        
        document.getElementById('runBtn').disabled = false;
        document.getElementById('runBtn').innerHTML = '<span class="material-icons-round">play_arrow</span> RUN QUEUE';
        document.getElementById('statusIndicator').innerText = "‚óè LIVE FEED ACTIVE";
        document.getElementById('statusIndicator').className = "status-live";
    };

    // --- 4. UPLOAD LOGIC ---
    const fileInput = document.getElementById('fileInput');
    const uploadText = document.getElementById('uploadText');
    const uploadBtn = document.getElementById('uploadBtn');

    fileInput.addEventListener('change', () => {
        if(fileInput.files.length) {
            uploadText.innerText = fileInput.files[0].name;
            uploadBtn.style.display = 'block';
        }
    });

    window.uploadMedia = async () => {
        const file = fileInput.files[0];
        if (!file) return;

        uploadBtn.innerText = "Uploading...";
        uploadBtn.disabled = true;

        const formData = new FormData();
        formData.append('file', file);
        formData.append('upload_preset', uploadPreset);

        const resourceType = file.type.includes('video') ? 'video' : 'image';

        try {
            const res = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/${resourceType}/upload`, { method: 'POST', body: formData });
            const data = await res.json();

            // Save to Firebase Library
            const newItem = {
                url: data.secure_url,
                type: resourceType,
                uploadedAt: Date.now(),
                duration: data.duration || 10 // Cloudinary gives duration for videos
            };
            
            await push(ref(db, 'media_library'), newItem);
            
            uploadBtn.innerText = "Success!";
            setTimeout(() => {
                uploadBtn.style.display = 'none';
                uploadBtn.innerText = "Start Upload";
                uploadBtn.disabled = false;
                uploadText.innerText = "Click to Upload";
                fileInput.value = "";
            }, 2000);

        } catch (err) {
            alert("Upload Failed");
            uploadBtn.disabled = false;
        }
    };
</script>
</body>
</html>
